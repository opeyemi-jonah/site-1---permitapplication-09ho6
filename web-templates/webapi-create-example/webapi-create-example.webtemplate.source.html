{% include 'portalwebapihelper' %}

<!-- Bootstrap & Leaflet CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

<style>
    /* Steps */
    .form-step {
        display: none;
    }

    .form-step.active {
        display: block;
    }

    .error {
        color: #dc3545;
        font-size: 0.9em;
        margin-top: .25rem;
        min-height: 1em;
    }

    /* Map */
    #map {
        height: 400px;
        border-radius: .375rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, .08);
    }

    /* Tabs */
    .form-nav-tabs .nav-link {
        cursor: pointer;
    }

    .form-nav-tabs .nav-link.disabled {
        color: #6c757d !important;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Suggestion dropdown */
    .positioner {
        position: relative;
    }

    .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1050;
        border: 1px solid #ccc;
        background: #fff;
        max-height: 260px;
        overflow: auto;
        border-radius: .375rem;
        box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
    }

    .suggestions div {
        padding: .5rem .75rem;
        cursor: pointer;
    }

    .suggestions div:hover {
        background: #f6f7f9;
    }

    .visually-hidden {
        position: absolute !important;
        height: 1px;
        width: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        white-space: nowrap;
    }
</style>

<div class="bg-light">
    <main class="container py-5">
        <div class="p-5 mb-4 bg-white rounded-3 shadow">
            <h1 class="display-5 fw-bold text-center mb-4">Application Form</h1>

            <form id="multiStepForm" novalidate>
                <!-- Tab Navigation for the Steps -->
                <ul class="nav nav-tabs form-nav-tabs mb-4" id="formTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="tab-1" data-bs-toggle="tab" href="#step-1" data-step="0"
                            role="tab" aria-controls="step-1" aria-selected="true">1. Applicant</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-2" data-bs-toggle="tab" href="#step-2" data-step="1"
                            role="tab" aria-controls="step-2" aria-selected="false">2. Project</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-3" data-bs-toggle="tab" href="#step-3" data-step="2"
                            role="tab" aria-controls="step-3" aria-selected="false">3. Schedule</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-4" data-bs-toggle="tab" href="#step-4" data-step="3"
                            role="tab" aria-controls="step-4" aria-selected="false">4. Assurance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-5" data-bs-toggle="tab" href="#step-5" data-step="4"
                            role="tab" aria-controls="step-5" aria-selected="false">5. Attachment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-6" data-bs-toggle="tab" href="#step-6" data-step="5"
                            role="tab" aria-controls="step-6" aria-selected="false">6. Acknowledge</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-7" data-bs-toggle="tab" href="#step-7" data-step="6"
                            role="tab" aria-controls="step-7" aria-selected="false">7. Review</a>
                    </li>
                </ul>

                <!-- Step 1: Applicant Information -->
                <div class="form-step active" data-step="0">
                    <h3 class="mb-4">Applicant Information</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label for="new_applicantname" class="form-label">Applicant Name</label>
                            <input type="text" class="form-control" id="new_applicantname" required>
                            <div id="err_applicantname" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="new_applicantemail" class="form-label">Applicant Email</label>
                            <input type="email" class="form-control" id="new_applicantemail" required>
                            <div id="err_applicantemail" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="new_applicantphone" class="form-label">Applicant Phone</label>
                            <input type="tel" class="form-control" id="new_applicantphone" required>
                            <div id="err_applicantphone" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="new_primarycontactname" class="form-label">Primary Contact Name</label>
                            <input type="text" class="form-control" id="new_primarycontactname" required>
                            <div id="err_primarycontactname" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="new_primarycontactemail" class="form-label">Primary Contact Email</label>
                            <input type="email" class="form-control" id="new_primarycontactemail" required>
                            <div id="err_primarycontactemail" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="new_primarycontactphone" class="form-label">Primary Contact Phone</label>
                            <input type="tel" class="form-control" id="new_primarycontactphone" required>
                            <div id="err_primarycontactphone" class="error"></div>
                        </div>
                        <div class="col-12">
                            <label for="new_organizationstructure" class="form-label">Organization Structure</label>
                            <textarea class="form-control" id="new_organizationstructure" rows="3"></textarea>
                            <div id="err_organizationstructure" class="error"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Project Details with Location Picker -->
                <div class="form-step" data-step="1">
                    <h3 class="mb-4">Project Details</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label for="new_plantname" class="form-label">Plant Name</label>
                            <input type="text" class="form-control" id="new_plantname" required>
                            <div id="err_plantname" class="error"></div>
                        </div>

                        <!-- Location search + suggestions -->
                        <div class="col-12 col-md-4 positioner">
                            <label for="new_location" class="form-label">Location (search)</label>
                            <input type="text" class="form-control" id="new_location"
                                placeholder="Type an address or place" autocomplete="off" required>
                            <div id="locationSuggestions" class="suggestions d-none"></div>
                            <div id="err_location" class="error"></div>
                        </div>

                        <div class="col-12 col-md-4">
                            <label for="new_plantdesign" class="form-label">Plant Design</label>
                            <select class="form-select" id="new_plantdesign" required>
                                <option value="">Select an option</option>
                                <option value="Option 1">Option 1</option>
                                <option value="Option 2">Option 2</option>
                                <option value="Option 3">Option 3</option>
                            </select>
                            <div id="err_plantdesign" class="error"></div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="new_latitude" class="form-label">Latitude</label>
                            <input type="text" class="form-control" id="new_latitude" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="new_longitude" class="form-label">Longitude</label>
                            <input type="text" class="form-control" id="new_longitude" readonly>
                        </div>

                        <div class="col-12 mt-2">
                            <div id="map" aria-label="Location map"></div>
                            <p id="locationMessage" class="mt-2 text-center text-muted">Search above or click on the map
                                to select a location.</p>
                        </div>

                        <div class="col-12">
                            <label for="new_rectormodel" class="form-label">Rector Model</label>
                            <input type="text" class="form-control" id="new_rectormodel">
                        </div>
                        <div class="col-12">
                            <label for="new_operatinghistory" class="form-label">Operating History</label>
                            <textarea class="form-control" id="new_operatinghistory" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Schedule & Scope -->
                <div class="form-step" data-step="2">
                    <h3 class="mb-4">Schedule & Scope</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label for="new_projectstartdate" class="form-label">Project Start Date</label>
                            <input type="date" class="form-control" id="new_projectstartdate" required>
                            <div id="err_startdate" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="new_projectenddate" class="form-label">Project End Date</label>
                            <input type="date" class="form-control" id="new_projectenddate" required>
                            <div id="err_enddate" class="error"></div>
                        </div>
                        <div class="col-12">
                            <label for="new_modificationdescription" class="form-label">Modification Description</label>
                            <textarea class="form-control" id="new_modificationdescription" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Assurance & Qualifications -->
                <div class="form-step" data-step="3">
                    <h3 class="mb-4">Assurance & Qualifications</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label for="new_financialassurance" class="form-label">Financial Assurance</label>
                            <select class="form-select" id="new_financialassurance" required>
                                <option value="">Select an option</option>
                                <option value="Assured">Assured</option>
                                <option value="Not Assured">Not Assured</option>
                            </select>
                            <div id="err_financialassurance" class="error"></div>
                        </div>
                        <div class="col-12">
                            <label for="new_experiencequalification" class="form-label">Experience Qualification</label>
                            <textarea class="form-control" id="new_experiencequalification" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Attachment -->
                <div class="form-step" data-step="4">
                    <h3 class="mb-4">Attachment</h3>
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="new_uploadfile" class="form-label">Upload File</label>
                            <input type="file" class="form-control" id="new_uploadfile">
                        </div>
                    </div>
                </div>

                <!-- Step 6: Acknowledgement -->
                <div class="form-step" data-step="5">
                    <h3 class="mb-4">Acknowledgement</h3>
                    <div class="row g-3">
                        <div class="col-12">
                            <p class="form-label mb-2">Terms Accepted</p>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="terms_yes" name="new_termsaccepted"
                                    value="Yes" required>
                                <label class="form-check-label" for="terms_yes">Yes</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="terms_no" name="new_termsaccepted"
                                    value="No">
                                <label class="form-check-label" for="terms_no">No</label>
                            </div>
                            <div id="err_terms" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="new_initials" class="form-label">Initials</label>
                            <input type="text" class="form-control" id="new_initials" required>
                            <div id="err_initials" class="error"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 7: Review & Confirm -->
                <div class="form-step" data-step="6">
                    <h3 class="mb-4">Review & Confirm</h3>
                    <div class="card p-4">
                        <h4 class="mb-3">Applicant Information</h4>
                        <p><strong>Applicant Name:</strong> <span id="confirm_applicantname"></span></p>
                        <p><strong>Applicant Email:</strong> <span id="confirm_applicantemail"></span></p>
                        <p><strong>Applicant Phone:</strong> <span id="confirm_applicantphone"></span></p>
                        <p><strong>Primary Contact Name:</strong> <span id="confirm_primarycontactname"></span></p>
                        <p><strong>Primary Contact Email:</strong> <span id="confirm_primarycontactemail"></span></p>
                        <p><strong>Primary Contact Phone:</strong> <span id="confirm_primarycontactphone"></span></p>
                        <p><strong>Organization Structure:</strong> <span id="confirm_organizationstructure"></span></p>

                        <hr class="my-4">

                        <h4 class="mb-3">Project Details</h4>
                        <p><strong>Plant Name:</strong> <span id="confirm_plantname"></span></p>
                        <p><strong>Location:</strong> <span id="confirm_location"></span></p>
                        <p><strong>Latitude:</strong> <span id="confirm_latitude"></span></p>
                        <p><strong>Longitude:</strong> <span id="confirm_longitude"></span></p>
                        <p><strong>Plant Design:</strong> <span id="confirm_plantdesign"></span></p>
                        <p><strong>Rector Model:</strong> <span id="confirm_rectormodel"></span></p>
                        <p><strong>Operating History:</strong> <span id="confirm_operatinghistory"></span></p>

                        <hr class="my-4">

                        <h4 class="mb-3">Schedule & Scope</h4>
                        <p><strong>Project Start Date:</strong> <span id="confirm_projectstartdate"></span></p>
                        <p><strong>Project End Date:</strong> <span id="confirm_projectenddate"></span></p>
                        <p><strong>Modification Description:</strong> <span id="confirm_modificationdescription"></span>
                        </p>

                        <hr class="my-4">

                        <h4 class="mb-3">Assurance & Qualifications</h4>
                        <p><strong>Financial Assurance:</strong> <span id="confirm_financialassurance"></span></p>
                        <p><strong>Experience Qualification:</strong> <span id="confirm_experiencequalification"></span>
                        </p>

                        <hr class="my-4">

                        <h4 class="mb-3">Acknowledgement</h4>
                        <p><strong>Terms Accepted:</strong> <span id="confirm_termsaccepted"></span></p>
                        <p><strong>Initials:</strong> <span id="confirm_initials"></span></p>

                        <p class="mt-4">Click submit to finalize.</p>
                    </div>
                </div>

                <!-- Form Navigation Buttons -->
                <div class="form-nav d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="button" class="btn btn-secondary" id="prevBtn">Previous</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
                    <button type="submit" class="btn btn-success" id="submitBtn" style="display:none;">Submit</button>
                </div>
            </form>
        </div>
    </main>
</div>

<!-- Bootstrap & Leaflet JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        /* ---------- Helpers ---------- */
        const $ = sel => document.querySelector(sel);
        const $$ = sel => Array.from(document.querySelectorAll(sel));
        const setErr = (id, msg) => { const el = document.getElementById(id); if (el) el.textContent = msg || ""; };

        /* ---------- Step controls ---------- */
        const form = $('#multiStepForm');
        const formSteps = $$('.form-step');
        const navTabs = $$('.form-nav-tabs .nav-link');
        const prevBtn = $('#prevBtn'), nextBtn = $('#nextBtn'), submitBtn = $('#submitBtn'), cancelBtn = $('#cancelBtn');
        let currentStep = 0;
        let completedSteps = new Set();

        function showStep(stepIndex) {
            formSteps.forEach(s => s.classList.remove('active'));
            navTabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });

            formSteps[stepIndex].classList.add('active');
            navTabs[stepIndex].classList.add('active');
            navTabs[stepIndex].setAttribute('aria-selected', 'true');

            prevBtn.style.display = (stepIndex === 0) ? 'none' : 'inline-block';
            nextBtn.style.display = (stepIndex === formSteps.length - 1) ? 'none' : 'inline-block';
            submitBtn.style.display = (stepIndex === formSteps.length - 1) ? 'inline-block' : 'none';

            navTabs.forEach((tab, idx) => {
                if (!completedSteps.has(idx) && idx > currentStep) tab.classList.add('disabled');
                else tab.classList.remove('disabled');
            });

            // Keep map sized correctly on step 2
            if (stepIndex === 1 && map) {
                setTimeout(() => map.invalidateSize(), 0);
            }

            // Populate review on last step
            if (stepIndex === formSteps.length - 1) {
                populateReview();
            }
        }

        navTabs.forEach(tab => {
            tab.addEventListener('click', e => {
                const idx = parseInt(tab.dataset.step);
                if (completedSteps.has(idx) || idx < currentStep) {
                    currentStep = idx; showStep(currentStep);
                } else {
                    e.preventDefault();
                }
            });
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 0) { currentStep--; showStep(currentStep); }
        });

        nextBtn.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                completedSteps.add(currentStep);
                currentStep++;
                showStep(currentStep);
            }
        });

        cancelBtn.addEventListener('click', () => {
            form.reset(); window.location.reload();
        });

        /* ---------- Validation ---------- */
        function validateStep(stepIndex) {
            let valid = true;

            // Basic required & pattern checks
            const step = formSteps[stepIndex];
            const requiredInputs = step.querySelectorAll('input[required], select[required], textarea[required]');
            requiredInputs.forEach(input => {
                const baseId = input.id.replace('new_', '');
                const errId = `err_${baseId}`;
                let msg = "";

                if (input.type === 'radio') {
                    // Acknowledgement radios
                    const group = form.querySelectorAll('input[name="new_termsaccepted"]');
                    const checked = Array.from(group).some(r => r.checked);
                    if (!checked) { valid = false; msg = "Please select an option."; }
                    setErr('err_terms', msg);
                    return;
                }

                const value = (input.value || "").trim();

                if (!value) {
                    valid = false; msg = "This field is required.";
                } else if (input.type === 'email' && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(value)) {
                    valid = false; msg = "Enter a valid email address.";
                } else if (input.type === 'tel' && !/^[0-9()+\-.\s]{7,20}$/.test(value)) {
                    valid = false; msg = "Enter a valid phone number.";
                }

                setErr(errId, msg);
            });

            // Additional rules on Schedule (step 2)
            if (stepIndex === 2) {
                const start = $('#new_projectstartdate').value;
                const end = $('#new_projectenddate').value;
                if (start && end && new Date(end) < new Date(start)) {
                    valid = false;
                    setErr('err_enddate', 'End date must be the same or after Start date.');
                } else {
                    setErr('err_enddate', '');
                }
            }

            // On Project step: require lat/long when location provided
            if (stepIndex === 1) {
                const loc = $('#new_location').value.trim();
                const lat = $('#new_latitude').value.trim();
                const lon = $('#new_longitude').value.trim();
                if (loc && (!lat || !lon)) {
                    valid = false;
                    setErr('err_location', 'Select a suggestion or click on the map to set coordinates.');
                } else {
                    setErr('err_location', '');
                }
            }

            return valid;
        }

        function populateReview() {
            const ids = [
                'new_applicantname', 'new_applicantemail', 'new_applicantphone',
                'new_primarycontactname', 'new_primarycontactemail', 'new_primarycontactphone',
                'new_organizationstructure', 'new_plantname', 'new_location', 'new_latitude', 'new_longitude',
                'new_plantdesign', 'new_rectormodel', 'new_operatinghistory', 'new_projectstartdate', 'new_projectenddate',
                'new_modificationdescription', 'new_financialassurance', 'new_experiencequalification', 'new_initials'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                const conf = document.getElementById('confirm_' + id.replace('new_', ''));
                if (el && conf) conf.textContent = (el.value || '').toString() || 'N/A';
            });
            // termsaccepted (radio)
            const terms = document.querySelector('input[name="new_termsaccepted"]:checked');
            const confTerms = document.getElementById('confirm_termsaccepted');
            if (confTerms) confTerms.textContent = terms ? terms.value : 'N/A';
        }

        /* ---------- Map & Location Search ---------- */
        let map = L.map('map').setView([39.381266, -97.922211], 4); // USA center-ish
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        let marker;

        function setMarker(lat, lon) {
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map);
            map.setView([lat, lon], 13);
        }

        // Reverse geocode helper (for map clicks)
        async function reverseGeocode(lat, lon) {
            try {
                const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                const data = await resp.json();
                if (data && data.display_name) return data.display_name;
            } catch (e) { console.warn('Reverse geocode failed', e); }
            return 'Selected Location';
        }

        map.on('click', async (e) => {
            const { lat, lng } = e.latlng;
            $('#new_latitude').value = lat.toFixed(6);
            $('#new_longitude').value = lng.toFixed(6);
            const name = await reverseGeocode(lat, lng);
            $('#new_location').value = name;
            $('#locationMessage').textContent = `Location set to: ${name}`;
            setMarker(lat, lng);
        });

        // Search with suggestions (Nominatim)
        const locInput = $('#new_location');
        const suggBox = $('#locationSuggestions');

        const debounce = (fn, delay = 350) => {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
        };

        locInput.addEventListener('input', debounce(async () => {
            const q = locInput.value.trim();
            if (q.length < 3) { suggBox.classList.add('d-none'); suggBox.innerHTML = ""; return; }
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                const places = await res.json();
                if (!places?.length) { suggBox.classList.add('d-none'); suggBox.innerHTML = ""; return; }
                suggBox.innerHTML = places.map(p =>
                    `<div data-lat="${p.lat}" data-lon="${p.lon}" data-display="${p.display_name}">${p.display_name}</div>`
                ).join('');
                suggBox.classList.remove('d-none');
            } catch (e) {
                suggBox.classList.add('d-none'); suggBox.innerHTML = "";
            }
        }, 400));

        suggBox.addEventListener('click', e => {
            const item = e.target.closest('div[data-lat]');
            if (!item) return;
            const lat = parseFloat(item.dataset.lat), lon = parseFloat(item.dataset.lon);
            $('#new_location').value = item.dataset.display;
            $('#new_latitude').value = lat.toFixed(6);
            $('#new_longitude').value = lon.toFixed(6);
            setMarker(lat, lon);
            suggBox.classList.add('d-none'); suggBox.innerHTML = "";
            setErr('err_location', '');
        });

        document.addEventListener('click', (e) => {
            if (!suggBox.contains(e.target) && e.target !== locInput) {
                suggBox.classList.add('d-none'); suggBox.innerHTML = "";
            }
        });

        /* ---------- Submit to Dataverse ---------- */
        form.addEventListener('submit', function (event) {
            event.preventDefault();
            if (!validateStep(currentStep)) return;

            // Collect all values
            const record = {
                new_applicantname: $('#new_applicantname').value.trim(),
                new_applicantemail: $('#new_applicantemail').value.trim(),
                new_applicantphone: $('#new_applicantphone').value.trim(),
                new_primarycontactname: $('#new_primarycontactname').value.trim(),
                new_primarycontactemail: $('#new_primarycontactemail').value.trim(),
                new_primarycontactphone: $('#new_primarycontactphone').value.trim(),
                new_organizationstructure: $('#new_organizationstructure').value.trim(),
                new_plantname: $('#new_plantname').value.trim(),
                new_location: $('#new_location').value.trim(),
                new_latitude: $('#new_latitude').value.trim(),
                new_longitude: $('#new_longitude').value.trim(),
                new_plantdesign: $('#new_plantdesign').value,
                new_rectormodel: $('#new_rectormodel').value.trim(),
                new_operatinghistory: $('#new_operatinghistory').value.trim(),
                new_projectstartdate: $('#new_projectstartdate').value || null,
                new_projectenddate: $('#new_projectenddate').value || null,
                new_modificationdescription: $('#new_modificationdescription').value.trim(),
                new_financialassurance: $('#new_financialassurance').value,
                new_experiencequalification: $('#new_experiencequalification').value.trim(),
                new_termsaccepted: (document.querySelector('input[name="new_termsaccepted"]:checked') || {}).value || null,
                new_initials: $('#new_initials').value.trim()
            };
            console.log("Submitting record:", record);

            // Disable submit to prevent double posts
            // submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';

            // ðŸ” POST the main record
          /**  webapi.safeAjax({
                type: "POST",
                url: "/_api/nrc_permit_devs", // table logical name
                contentType: "application/json",
                data: JSON.stringify(record),
                success: function (data, textStatus, xhr) {
                    const newId = xhr.getResponseHeader("entityid");
                    const fileInput = $('#new_uploadfile');

                    // If no file, finish
                    if (!fileInput.files || fileInput.files.length === 0) {
                        done(true);
                        return;
                    }

                    // Read file -> base64 -> create annotation
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    reader.onload = function () {
                        const base64 = reader.result.split(",")[1];
                        const note = {
                            subject: "Attachment",
                            filename: file.name,
                            mimetype: file.type || "application/octet-stream",
                            documentbody: base64,
                            // Bind note to the created record (replace the navigation property below)
                            "objectid_nrc_permit_dev@odata.bind": `/nrc_permit_devs(${newId})`
                        };

                        webapi.safeAjax({
                            type: "POST",
                            url: "/_api/annotations",
                            contentType: "application/json",
                            data: JSON.stringify(note),
                            success: function () { done(true); },
                            error: function (err) { console.error("File upload error", err); done(false, "Record created but file upload failed."); }
                        });
                    };
                    reader.onerror = () => { console.error("File read error"); done(false, "Record created but file read failed."); };
                    reader.readAsDataURL(file);
                },
                error: function (xhr) {
                    console.error("Create error", xhr);
                    submitBtn.disabled = false; submitBtn.textContent = 'Submit';
                    alert("There was an error creating the record. Please try again.");
                }
            });
            **/

            function done(success, message) {
                submitBtn.disabled = false; submitBtn.textContent = 'Submit';
                if (success) {
                    alert(message || "Record created successfully!");
                    form.reset(); currentStep = 0; completedSteps = new Set(); showStep(0);
                    // Reset map & marker
                    if (marker) { map.removeLayer(marker); marker = null; }
                    map.setView([39.381266, -97.922211], 4);
                } else {
                    alert(message || "There was an error completing the request.");
                }
            }
        });

        // Initialize first step view
        showStep(currentStep);
    });
</script>