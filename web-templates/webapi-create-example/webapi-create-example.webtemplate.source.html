{% include 'portalwebapihelper' %}

<style>
    /* Steps */
    .form-step {
        display: none;
    }

    .form-step.active {
        display: block;
    }

    .error {
        color: #dc3545;
        font-size: 0.9em;
        margin-top: .25rem;
        min-height: 1em;
    }

    /* Map */
    #map {
        height: 400px;
        border-radius: .375rem;
        box-shadow: 0 2px 6px rgba(0, 0, 0, .08);
    }

    /* Tabs */
    .form-nav-tabs .nav-link {
        cursor: pointer;
    }

    .form-nav-tabs .nav-link.disabled {
        color: #6c757d !important;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Suggestion dropdown */
    .positioner {
        position: relative;
    }

    .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1050;
        border: 1px solid #ccc;
        background: #fff;
        max-height: 260px;
        overflow: auto;
        border-radius: .375rem;
        box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
    }

    .suggestions div {
        padding: .5rem .75rem;
        cursor: pointer;
    }

    .suggestions div:hover {
        background: #f6f7f9;
    }

    .visually-hidden {
        position: absolute !important;
        height: 1px;
        width: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        white-space: nowrap;
    }
</style>

<script>

    document.addEventListener("DOMContentLoaded", async function () {
        const today = new Date().toISOString().split('T')[0];
        const tomorrow = new Date(Date.now() + 864e5).toISOString().split('T')[0];

        document.getElementById("cre6c_projectstartdate").setAttribute('min', today);
        document.getElementById("cre6c_projectenddate").setAttribute('min', tomorrow);


        // Plant Design (single-select)
        const plant_design_options = {
            564980000: "Plant Design 1",
            564980001: "Plant Design 2",
            564980002: "Plant Design 3",
        };
        const plant_designs_select = document.getElementById("cre6c_plantdesign");
        Object.entries(plant_design_options).forEach(([value, label]) => {
            const option = document.createElement("option");
            option.value = value;
            option.text = label;
            plant_designs_select.appendChild(option);
        });

        // Financial Assurance (single-select)
        const financial_assurance_options = {
            564980000: "Assurance 1",
            564980001: "Assurance 2",
            564980002: "Assurance 3",
        };
        const financial_assurance_select = document.getElementById("cre6c_financialassurance");
        Object.entries(financial_assurance_options).forEach(([value, label]) => {
            const option = document.createElement("option");
            option.value = value;
            option.text = label;
            financial_assurance_select.appendChild(option);
        });
    });
</script>

<div class="bg-light">
    <main class="container py-5">
        <div class="p-5 mb-4 bg-white rounded-3 shadow">
            <h1 class="display-5 fw-bold text-center mb-4">Application Form</h1>

            <form id="multiStepForm" novalidate>
                <!-- Tab Navigation for the Steps -->
                <ul class="nav nav-tabs form-nav-tabs mb-4" id="formTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="tab-1" data-bs-toggle="tab" href="#step-1" data-step="0"
                            role="tab" aria-controls="step-1" aria-selected="true">1. Applicant</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-2" data-bs-toggle="tab" href="#step-2" data-step="1"
                            role="tab" aria-controls="step-2" aria-selected="false">2. Project</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-3" data-bs-toggle="tab" href="#step-3" data-step="2"
                            role="tab" aria-controls="step-3" aria-selected="false">3. Schedule</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-4" data-bs-toggle="tab" href="#step-4" data-step="3"
                            role="tab" aria-controls="step-4" aria-selected="false">4. Assurance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-5" data-bs-toggle="tab" href="#step-5" data-step="4"
                            role="tab" aria-controls="step-5" aria-selected="false">5. Attachment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-6" data-bs-toggle="tab" href="#step-6" data-step="5"
                            role="tab" aria-controls="step-6" aria-selected="false">6. Acknowledge</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="tab-7" data-bs-toggle="tab" href="#step-7" data-step="6"
                            role="tab" aria-controls="step-7" aria-selected="false">7. Review</a>
                    </li>
                </ul>

                <!-- Step 1: Applicant Information -->
                <div class="form-step active" data-step="0">
                    <h3 class="mb-4">Applicant Information</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label for="cre6c_applicantname" class="form-label">Applicant Name</label>
                            <input type="text" class="form-control" id="cre6c_applicantname" required>
                            <div id="err_applicantname" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="cre6c_applicantemail" class="form-label">Applicant Email</label>
                            <input type="email" class="form-control" id="cre6c_applicantemail" required>
                            <div id="err_applicantemail" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="cre6c_applicantphone" class="form-label">Applicant Phone</label>
                            <input type="tel" class="form-control" id="cre6c_applicantphone" required>
                            <div id="err_applicantphone" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="cre6c_primarycontactname" class="form-label">Primary Contact Name</label>
                            <input type="text" class="form-control" id="cre6c_primarycontactname" required>
                            <div id="err_primarycontactname" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="cre6c_primarycontactemail" class="form-label">Primary Contact Email</label>
                            <input type="email" class="form-control" id="cre6c_primarycontactemail" required>
                            <div id="err_primarycontactemail" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="cre6c_primarycontactphone" class="form-label">Primary Contact Phone</label>
                            <input type="tel" class="form-control" id="cre6c_primarycontactphone" required>
                            <div id="err_primarycontactphone" class="error"></div>
                        </div>
                        <div class="col-12">
                            <label for="cre6c_organizationstructure" class="form-label">Organization Structure</label>
                            <textarea class="form-control" id="cre6c_organizationstructure" rows="3"></textarea>
                            <div id="err_organizationstructure" class="error"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Project Details with Location Picker -->
                <div class="form-step" data-step="1">
                    <h3 class="mb-4">Project Details</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label for="cre6c_plantname" class="form-label">Plant Name</label>
                            <input type="text" class="form-control" id="cre6c_plantname" required>
                            <div id="err_plantname" class="error"></div>
                        </div>

                        <!-- Location search + suggestions -->
                        <div class="col-12 col-md-4 positioner">
                            <label for="cre6c_location" class="form-label">Location (search)</label>
                            <input type="text" class="form-control" id="cre6c_location"
                                placeholder="Type an address or place" autocomplete="off" required>
                            <div id="locationSuggestions" class="suggestions d-none"></div>
                            <div id="err_location" class="error"></div>
                        </div>

                        <div class="col-12 col-md-4">
                            <label for="cre6c_plantdesign" class="form-label">Plant Design</label>
                            <select class="form-select" id="cre6c_plantdesign" required>
                                <option value="">Select an option</option>
                            </select>
                            <div id="err_plantdesign" class="error"></div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="cre6c_latitude" class="form-label">Latitude</label>
                            <input type="text" class="form-control" id="cre6c_latitude" readonly>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="cre6c_longitude" class="form-label">Longitude</label>
                            <input type="text" class="form-control" id="cre6c_longitude" readonly>
                        </div>

                        <div class="col-12 mt-2">
                            <div id="map" aria-label="Location map"></div>
                            <p id="locationMessage" class="mt-2 text-center text-muted">Search above or click on the map
                                to select a location.</p>
                        </div>

                        <div class="col-12">
                            <label for="cre6c_refactormodel" class="form-label">Reactor Model</label>
                            <input type="text" class="form-control" id="cre6c_refactormodel">
                        </div>
                        <div class="col-12">
                            <label for="cre6c_operatinghistory" class="form-label">Operating History</label>
                            <textarea class="form-control" id="cre6c_operatinghistory" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Schedule & Scope -->
                <div class="form-step" data-step="2">
                    <h3 class="mb-4">Schedule & Scope</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label for="cre6c_projectstartdate" class="form-label">Project Start Date</label>
                            <input type="date" class="form-control" id="cre6c_projectstartdate" required>
                            <div id="err_startdate" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="cre6c_projectenddate" class="form-label">Project End Date</label>
                            <input type="date" class="form-control" id="cre6c_projectenddate" required>
                            <div id="err_enddate" class="error"></div>
                        </div>
                        <div class="col-12">
                            <label for="cre6c_modificationdescription" class="form-label">Modification
                                Description</label>
                            <textarea class="form-control" id="cre6c_modificationdescription" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Assurance & Qualifications -->
                <div class="form-step" data-step="3">
                    <h3 class="mb-4">Assurance & Qualifications</h3>
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label for="cre6c_financialassurance" class="form-label">Financial Assurance</label>
                            <select class="form-select" id="cre6c_financialassurance" required>
                                <option value="">Select an option</option>
                            </select>
                            <div id="err_financialassurance" class="error"></div>
                        </div>
                        <div class="col-12">
                            <label for="cre6c_experiencequalifications" class="form-label">Experience
                                Qualification</label>
                            <textarea class="form-control" id="cre6c_experiencequalifications" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Attachment -->
                <div class="form-step" data-step="4">
                    <h3 class="mb-4">Attachment</h3>
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="cre6c_fileupload" class="form-label">Upload File</label>
                            <input type="file" class="form-control" id="cre6c_fileupload"
                                accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        </div>
                    </div>
                </div>

                <!-- Step 6: Acknowledgement -->
                <div class="form-step" data-step="5">
                    <h3 class="mb-4">Acknowledgement</h3>
                    <div class="row g-3">
                        <div class="col-12">
                            <p class="form-label mb-2">Terms Accepted</p>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="terms_yes" name="cre6c_termsaccepted"
                                    value="Yes" required>
                                <label class="form-check-label" for="terms_yes">Yes</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" id="terms_no" name="cre6c_termsaccepted"
                                    value="No">
                                <label class="form-check-label" for="terms_no">No</label>
                            </div>
                            <div id="err_terms" class="error"></div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="cre6c_initials" class="form-label">Initials</label>
                            <input type="text" class="form-control" id="cre6c_initials" required>
                            <div id="err_initials" class="error"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 7: Review & Confirm -->
                <div class="form-step" data-step="6">
                    <h3 class="mb-4">Review & Confirm</h3>
                    <div class="card p-4">
                        <h4 class="mb-3">Applicant Information</h4>
                        <p><strong>Applicant Name:</strong> <span id="confirm_applicantname"></span></p>
                        <p><strong>Applicant Email:</strong> <span id="confirm_applicantemail"></span></p>
                        <p><strong>Applicant Phone:</strong> <span id="confirm_applicantphone"></span></p>
                        <p><strong>Primary Contact Name:</strong> <span id="confirm_primarycontactname"></span></p>
                        <p><strong>Primary Contact Email:</strong> <span id="confirm_primarycontactemail"></span></p>
                        <p><strong>Primary Contact Phone:</strong> <span id="confirm_primarycontactphone"></span></p>
                        <p><strong>Organization Structure:</strong> <span id="confirm_organizationstructure"></span></p>

                        <hr class="my-4">

                        <h4 class="mb-3">Project Details</h4>
                        <p><strong>Plant Name:</strong> <span id="confirm_plantname"></span></p>
                        <p><strong>Location:</strong> <span id="confirm_location"></span></p>
                        <p><strong>Latitude:</strong> <span id="confirm_latitude"></span></p>
                        <p><strong>Longitude:</strong> <span id="confirm_longitude"></span></p>
                        <p><strong>Plant Design:</strong> <span id="confirm_plantdesign"></span></p>
                        <p><strong>Reactor Model:</strong> <span id="confirm_refactormodel"></span></p>
                        <p><strong>Operating History:</strong> <span id="confirm_operatinghistory"></span></p>

                        <hr class="my-4">

                        <h4 class="mb-3">Schedule & Scope</h4>
                        <p><strong>Project Start Date:</strong> <span id="confirm_projectstartdate"></span></p>
                        <p><strong>Project End Date:</strong> <span id="confirm_projectenddate"></span></p>
                        <p><strong>Modification Description:</strong> <span id="confirm_modificationdescription"></span>
                        </p>

                        <hr class="my-4">

                        <h4 class="mb-3">Assurance & Qualifications</h4>
                        <p><strong>Financial Assurance:</strong> <span id="confirm_financialassurance"></span></p>
                        <p><strong>Experience Qualification:</strong> <span id="confirm_experiencequalification"></span>
                        </p>

                        <hr class="my-4">

                        <h4 class="mb-3">Acknowledgement</h4>
                        <p><strong>Terms Accepted:</strong> <span id="confirm_termsaccepted"></span></p>
                        <p><strong>Initials:</strong> <span id="confirm_initials"></span></p>

                        <p class="mt-4">Click submit to finalize.</p>
                    </div>
                </div>

                <!-- Form Navigation Buttons -->
                <div class="form-nav d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="button" class="btn btn-secondary" id="prevBtn">Previous</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
                    <button type="submit" class="btn btn-success" id="submitBtn" style="display:none;">Submit</button>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        /*---------Setup project end date range----------*/
        const startDateInput = document.getElementById('cre6c_projectstartdate');

        startDateInput.addEventListener('change', function () {
            const startDate = this.value;
            const endDateInput = document.getElementById('cre6c_projectenddate');
            if (startDate) {
                endDateInput.min = startDate;
                if (endDateInput.value && endDateInput.value < startDate) {
                    endDateInput.value = startDate; // Reset end date if it's before start date
                }
            } else {
                endDateInput.min = '';
            }
        });

        /* ---------- Helpers ---------- */
        const $ = sel => document.querySelector(sel);
        const $$ = sel => Array.from(document.querySelectorAll(sel));
        const setErr = (id, msg) => { const el = document.getElementById(id); if (el) el.textContent = msg || ""; };

        /* ---------- Step controls ---------- */
        const form = $('#multiStepForm');
        const formSteps = $$('.form-step');
        const navTabs = $$('.form-nav-tabs .nav-link');
        const prevBtn = $('#prevBtn'), nextBtn = $('#nextBtn'), submitBtn = $('#submitBtn'), cancelBtn = $('#cancelBtn');
        let currentStep = 0;
        let completedSteps = new Set();

        function showStep(stepIndex) {
            formSteps.forEach(s => s.classList.remove('active'));
            navTabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });

            formSteps[stepIndex].classList.add('active');
            navTabs[stepIndex].classList.add('active');
            navTabs[stepIndex].setAttribute('aria-selected', 'true');

            prevBtn.style.display = (stepIndex === 0) ? 'none' : 'inline-block';
            nextBtn.style.display = (stepIndex === formSteps.length - 1) ? 'none' : 'inline-block';
            submitBtn.style.display = (stepIndex === formSteps.length - 1) ? 'inline-block' : 'none';

            navTabs.forEach((tab, idx) => {
                if (!completedSteps.has(idx) && idx > currentStep) tab.classList.add('disabled');
                else tab.classList.remove('disabled');
            });

            // Keep map sized correctly on step 2
            if (stepIndex === 1 && map) {
                setTimeout(() => map.invalidateSize(), 0);
            }

            // Populate review on last step
            if (stepIndex === formSteps.length - 1) {
                populateReview();
            }
        }

        navTabs.forEach(tab => {
            tab.addEventListener('click', e => {
                const idx = parseInt(tab.dataset.step);
                if (completedSteps.has(idx) || idx < currentStep) {
                    currentStep = idx; showStep(currentStep);
                } else {
                    e.preventDefault();
                }
            });
        });

        prevBtn.addEventListener('click', () => {
            if (currentStep > 0) { currentStep--; showStep(currentStep); }
        });

        nextBtn.addEventListener('click', () => {
            // if (validateStep(currentStep)) {
            completedSteps.add(currentStep);
            currentStep++;
            showStep(currentStep);
            // }
        });

        cancelBtn.addEventListener('click', () => {
            form.reset(); window.location.reload();
        });

        /* ---------- Validation ---------- */
        function validateStep(stepIndex) {
            let valid = true;

            // Basic required & pattern checks
            const step = formSteps[stepIndex];
            const requiredInputs = step.querySelectorAll('input[required], select[required], textarea[required]');
            requiredInputs.forEach(input => {
                const baseId = input.id.replace('cre6c_', '');
                const errId = `err_${baseId}`;
                let msg = "";

                if (input.type === 'radio') {
                    // Acknowledgement radios
                    const group = form.querySelectorAll('input[name="cre6c_termsaccepted"]');
                    const checked = Array.from(group).some(r => r.checked);
                    if (!checked) { valid = false; msg = "Please select an option."; }
                    setErr('err_terms', msg);
                    return;
                }

                const value = (input.value || "").trim();

                if (!value) {
                    valid = false; msg = "This field is required.";
                } else if (input.type === 'email' && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(value)) {
                    valid = false; msg = "Enter a valid email address.";
                } else if (input.type === 'tel' && !/^[0-9()+\-.\s]{7,20}$/.test(value)) {
                    valid = false; msg = "Enter a valid phone number.";
                }

                setErr(errId, msg);
            });

            // Additional rules on Schedule (step 2)
            if (stepIndex === 2) {
                const start = $('#cre6c_projectstartdate').value;
                const end = $('#cre6c_projectenddate').value;
                if (start && end && new Date(end) < new Date(start)) {
                    valid = false;
                    setErr('err_enddate', 'End date must be the same or after Start date.');
                } else {
                    setErr('err_enddate', '');
                }
            }

            // On Project step: require lat/long when location provided
            if (stepIndex === 1) {
                const loc = $('#cre6c_location').value.trim();
                const lat = $('#cre6c_latitude').value.trim();
                const lon = $('#cre6c_longitude').value.trim();
                if (loc && (!lat || !lon)) {
                    valid = false;
                    setErr('err_location', 'Select a suggestion or click on the map to set coordinates.');
                } else {
                    setErr('err_location', '');
                }
            }

            return valid;
        }

        function populateReview() {
            const ids = [
                'cre6c_applicantname', 'cre6c_applicantemail', 'cre6c_applicantphone',
                'cre6c_primarycontactname', 'cre6c_primarycontactemail', 'cre6c_primarycontactphone',
                'cre6c_organizationstructure', 'cre6c_plantname', 'cre6c_location', 'cre6c_latitude', 'cre6c_longitude',
                'cre6c_plantdesign', 'cre6c_refactormodel', 'cre6c_operatinghistory', 'cre6c_projectstartdate', 'cre6c_projectenddate',
                'cre6c_modificationdescription', 'cre6c_financialassurance', 'cre6c_experiencequalifications', 'cre6c_initials'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                const conf = document.getElementById('confirm_' + id.replace('cre6c_', ''));
                if (el && conf) conf.textContent = (el.value || '').toString() || 'N/A';
            });
            // termsaccepted (radio)
            const terms = document.querySelector('input[name="cre6c_termsaccepted"]:checked');
            const confTerms = document.getElementById('confirm_termsaccepted');
            if (confTerms) confTerms.textContent = terms ? terms.value : 'N/A';
        }

        /* ---------- Map & Location Search ---------- */
        let map = L.map('map').setView([39.381266, -97.922211], 4); // USA center-ish
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        let marker;

        function setMarker(lat, lon) {
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map);
            map.setView([lat, lon], 13);
        }

        // Reverse geocode helper (for map clicks)
        // Replace with your Power Automate flow URL
        //TODO: place url in a secure location (e.g., environment variable)
        const FLOW_GEO_URL = "https://prod-137.westus.logic.azure.com:443/workflows/2c0a2c10de1f40ff8af5584929aa70c7/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=0jf2MWWx2DppTvJxqePK_d5Y6HZmZkVagfUhQaFpyk0";
        
        // ----- FLOW HELPERS -----
        async function reverseGeocode(lat, lon) {
            try {
                const resp = await fetch(FLOW_GEO_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ mode: "reverse", lat, lon })
                });
                const data = await resp.json();
                return data.display_name || "Selected Location";
            } catch (e) {
                console.warn("Reverse geocode failed", e);
                return "Selected Location";
            }
        }

        async function searchLocations(query) {
            try {
                const resp = await fetch(FLOW_GEO_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ mode: "search", query })
                });
                return await resp.json();
            } catch (e) {
                console.warn("Search failed", e);
                return [];
            }
        }

        // ----- MAP CLICK -----
        map.on("click", async (e) => {
            const { lat, lng } = e.latlng;
            $("#cre6c_latitude").value = lat.toFixed(6);
            $("#cre6c_longitude").value = lng.toFixed(6);

            const name = await reverseGeocode(lat, lng);
            $("#cre6c_location").value = name;
            $("#locationMessage").textContent = `Location set to: ${name}`;
            setMarker(lat, lng);
        });

        // ----- SEARCH WITH SUGGESTIONS -----
        const locInput = $("#cre6c_location");
        const suggBox = $("#locationSuggestions");

        const debounce = (fn, delay = 350) => {
            let t;
            return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
        };

        locInput.addEventListener("input", debounce(async () => {
            const q = locInput.value.trim();
            if (q.length < 3) { suggBox.classList.add("d-none"); suggBox.innerHTML = ""; return; }

            const places = await searchLocations(q);
            if (!places?.length) { suggBox.classList.add("d-none"); suggBox.innerHTML = ""; return; }

            suggBox.innerHTML = places.map(p =>
                `<div data-lat="${p.lat}" data-lon="${p.lon}" data-display="${p.display_name}">
            ${p.display_name}
        </div>`
            ).join("");
            suggBox.classList.remove("d-none");
        }, 400));

        suggBox.addEventListener("click", e => {
            const item = e.target.closest("div[data-lat]");
            if (!item) return;
            const lat = parseFloat(item.dataset.lat), lon = parseFloat(item.dataset.lon);

            $("#cre6c_location").value = item.dataset.display;
            $("#cre6c_latitude").value = lat.toFixed(6);
            $("#cre6c_longitude").value = lon.toFixed(6);
            setMarker(lat, lon);

            suggBox.classList.add("d-none");
            suggBox.innerHTML = "";
            setErr("err_location", "");
        });

        document.addEventListener("click", (e) => {
            if (!suggBox.contains(e.target) && e.target !== locInput) {
                suggBox.classList.add("d-none"); suggBox.innerHTML = "";
            }
        });


        /* ---------- Submit to Dataverse ---------- */
        form.addEventListener('submit', function (event) {
            event.preventDefault();
            if (!validateStep(currentStep)) return;

            const terms_accepted = document.querySelector('input[name="cre6c_termsaccepted"]:checked');
            const refactor_model = document.getElementById('cre6c_refactormodel').value.trim();
            const plant_design = parseInt($('#cre6c_plantdesign').value);
            const financial_assurance = parseInt($('#cre6c_financialassurance').value);

            // Collect all values from the form
            const record = {
                cre6c_name: $('#cre6c_applicantname').value.trim(),
                cre6c_applicantemail: $('#cre6c_applicantemail').value.trim(),
                cre6c_applicantphone: $('#cre6c_applicantphone').value.trim(),
                cre6c_primarycontactname: $('#cre6c_primarycontactname').value.trim(),
                cre6c_primarycontactemail: $('#cre6c_primarycontactemail').value.trim(),
                cre6c_primarycontactphone: $('#cre6c_primarycontactphone').value.trim(),
                cre6c_organizationstructure: $('#cre6c_organizationstructure').value.trim(),
                cre6c_plantname: $('#cre6c_plantname').value.trim(),
                cre6c_location: $('#cre6c_location').value.trim(),
                cre6c_latitude: $('#cre6c_latitude').value.trim(),
                cre6c_longitude: $('#cre6c_longitude').value.trim(),
                cre6c_plantdesign: plant_design || null,
                cre6c_refactormodel: refactor_model,
                cre6c_operatinghistory: $('#cre6c_operatinghistory').value.trim(),
                cre6c_projectstartdate: $('#cre6c_projectstartdate').value || null,
                cre6c_projectenddate: $('#cre6c_projectenddate').value || null,
                cre6c_modificationdescription: $('#cre6c_modificationdescription').value.trim(),
                cre6c_financialassurance: financial_assurance || null,
                cre6c_experiencequalifications: $('#cre6c_experiencequalifications').value.trim(),
                cre6c_termsaccepted: terms_accepted ? 'Yes' : 'No',
                // cre6c_termsaccepted: terms_accepted ? (terms_accepted.value === 'Yes') : false,
                cre6c_initials: $('#cre6c_initials').value.trim()
            };

            // Disable submit to prevent double posts
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            console.log("Submitting record:", record);
            // Step 1: Create main record
            webapi.safeAjax({
                type: "POST",
                url: "/_api/cre6c_nrc_permit_devs", // entity set
                contentType: "application/json",
                data: JSON.stringify(record),
                success: function (data, textStatus, xhr) {
                    const newId = xhr.getResponseHeader("entityid");
                    const fileInput = $('#cre6c_fileupload');
                    done(true, "Record created successfully!");
                },
                error: function (xhr) {
                    console.error("Create error", xhr);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                    alert("There was an error creating the record. Please try again.");
                }
            });

            function done(success, message) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';

                if (success) {
                    alert(message || "Record created successfully!");
                    form.reset();
                    currentStep = 0;
                    completedSteps = new Set();
                    showStep(0);
                    // Reset map & marker
                    if (marker) { map.removeLayer(marker); marker = null; }
                    map.setView([39.381266, -97.922211], 4);
                } else {
                    alert(message || "There was an error completing the request.");
                }
            }
        });

        // Initialize first step view
        showStep(currentStep);
    });
</script>