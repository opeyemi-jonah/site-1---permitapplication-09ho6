{% if user %}
<div class="permits-container">
  <!-- Header -->
  <div class="permits-header">
    <h1><i class="fas fa-file-alt"></i> Application Details</h1>
    <p>Detailed view of your Environmental Review Application</p>
  </div>

  <!-- Back Button -->
  <div class="mb-3">
    <a href="/my-permits" class="btn btn-outline-primary">
      <i class="fas fa-arrow-left"></i> Back to My Permits
    </a>
  </div>

  <!-- Application Details -->
  <div id="applicationDetails">
    <div class="text-center p-5">
      <i class="fas fa-spinner fa-spin fa-2x"></i>
      <p class="mt-2">Loading application details...</p>
    </div>
  </div>
</div>
{% else %}
<div class="container py-5 text-center">
  <div class="card mx-auto p-4" style="max-width: 400px;">
    <h2 class="mb-3"><i class="fas fa-lock text-warning"></i> Login Required</h2>
    <p class="mb-4">You must be signed in to view application details.</p>
    <a href="/signin" class="btn btn-primary">Sign In</a>
  </div>
</div>
{% endif %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const applicationId = urlParams.get("id");
    console.log('APP ID: ', applicationId)
    if (applicationId) {
      loadApplicationDetails(applicationId);
    } else {
      showError("No application ID provided");
    }
  });

  async function loadApplicationDetails(applicationId) {
    const container = document.getElementById("applicationDetails");
    try {
      // Fetch application details
      const response = await fetch(
        `/_api/cre6c_nrc_permits_tables(${applicationId})`,
        {
          headers: {
            "Accept": "application/json",
            "OData-MaxVersion": "4.0",
            "OData-Version": "4.0"
            // Authorization header is automatically handled in Power Pages
          },
        }
      );
      if (!response.ok) {
        throw new Error("Application not found or access denied");
      }
      const application = await response.json();
      displayApplicationDetails(application);
    } catch (error) {
      console.error("Error loading application:", error);
      showError("Failed to load application details");
    }
  }

  function displayApplicationDetails(app) {
    const container = document.getElementById("applicationDetails");
    const statusClass = getStatusClass(app.cre6c_applicationstatus);

    container.innerHTML = `
      <!-- Status Card -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-info-circle"></i> Application Status</h4>
          <span class="status-badge ${statusClass}">${app.cre6c_applicationstatus || "Pending"}</span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Application ID:</strong> ${app.cre6c_environmentalreviewapplicationid}</p>
              <p><strong>Submitted:</strong> ${app.createdon ? new Date(app.createdon).toLocaleDateString() : "Not provided"}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Plant Name:</strong> ${app.cre6c_plantname || "Not specified"}</p>
              <p><strong>Location:</strong> ${app.cre6c_location || "Not specified"}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Applicant Information -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-user"></i> Applicant Information</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Name:</strong> ${app.cre6c_applicantname || "Not provided"}</p>
              <p><strong>Email:</strong> ${app.cre6c_applicantemail || "Not provided"}</p>
              <p><strong>Phone:</strong> ${app.cre6c_applicantphone || "Not provided"}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Primary Contact:</strong> ${app.cre6c_primarycontactname || "Not provided"}</p>
              <p><strong>Contact Email:</strong> ${app.cre6c_primarycontactemail || "Not provided"}</p>
              <p><strong>Contact Phone:</strong> ${app.cre6c_primarycontactphone || "Not provided"}</p>
            </div>
          </div>
          ${
            app.cre6c_organizationstructure
              ? `
            <div class="row mt-3">
              <div class="col-12">
                <p><strong>Organization Structure:</strong></p>
                <p class="bg-light p-3 rounded">${app.cre6c_organizationstructure}</p>
              </div>
            </div>`
              : ""
          }
        </div>
      </div>

      <!-- Project Details -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-industry"></i> Project Details</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Plant Design:</strong> ${app.cre6c_plantdesign || "Not provided"}</p>
              <p><strong>Reactor Model:</strong> ${app.cre6c_reactormodel || "Not provided"}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Latitude:</strong> ${app.cre6c_latitude || "Not provided"}</p>
              <p><strong>Longitude:</strong> ${app.cre6c_longitude || "Not provided"}</p>
            </div>
          </div>
          ${
            app.cre6c_operatinghistory
              ? `
            <div class="row mt-3">
              <div class="col-12">
                <p><strong>Operating History:</strong></p>
                <p class="bg-light p-3 rounded">${app.cre6c_operatinghistory}</p>
              </div>
            </div>`
              : ""
          }
        </div>
      </div>

      <!-- Schedule & Scope -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Schedule & Scope</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Projected Start Date:</strong> ${app.cre6c_projectedstartdate ? new Date(app.cre6c_projectedstartdate).toLocaleDateString() : "Not specified"}</p>
              <p><strong>Projected End Date:</strong> ${app.cre6c_projectedenddate ? new Date(app.cre6c_projectedenddate).toLocaleDateString() : "Not specified"}</p>
            </div>
          </div>
          ${
            app.cre6c_modificationdescription
              ? `
            <div class="row mt-3">
              <div class="col-12">
                <p><strong>Modification Description:</strong></p>
                <p class="bg-light p-3 rounded">${app.cre6c_modificationdescription}</p>
              </div>
            </div>`
              : ""
          }
        </div>
      </div>

      <!-- Assurance & Qualifications -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Assurance & Qualifications</h5>
        </div>
        <div class="card-body">
          <p><strong>Financial Assurance:</strong> ${app.cre6c_financialassurance || "Not selected"}</p>
          ${
            app.cre6c_experiencequalifications
              ? `
            <div class="mt-3">
              <p><strong>Experience and Qualifications:</strong></p>
              <p class="bg-light p-3 rounded">${app.cre6c_experiencequalifications}</p>
            </div>`
              : ""
          }
        </div>
      </div>

      <!-- Acknowledgement -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-check-circle"></i> Acknowledgement</h5>
        </div>
        <div class="card-body">
          <p><strong>Initials:</strong> ${app.cre6c_initials || "Not provided"}</p>
          <p class="text-muted">Applicant certified agreement to terms and conditions</p>
        </div>
      </div>
    `;
  }

  function getStatusClass(status) {
    switch (status?.toLowerCase()) {
      case "approved": return "status-approved";
      case "denied": return "status-denied";
      case "under review": return "status-under-review";
      default: return "status-pending";
    }
  }

  function showError(message) {
    const container = document.getElementById("applicationDetails");
    container.innerHTML = `
      <div class="alert alert-danger text-center">
        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
        <h4>Error</h4>
        <p>${message}</p>
        <a href="/my-permits" class="btn btn-primary">Return to My Permits</a>
      </div>
    `;
  }
</script>
