{% if user %}
  {% include 'portalwebapihelper' %}
  {% assign current_user = user.emailaddress1 %}
  <!-- Get user email -->
  <div id="user-data" data-user='{{ current_user | jsonify | escape }}'></div>

  <div class="permits-container">
    <div class="permits-header">
      <h1><i class="fas fa-file-contract"></i> My Permits Dashboard</h1>
      <p>Track your Environmental Review Applications and their approval status</p>
    </div>

    <div class="permits-stats">
      <div class="stat-card">
        <div class="stat-number" id="totalCount">0</div>
        <div class="stat-label">Total Applications</div>
      </div>
      <div class="stat-card stat-card-pending">
        <div class="stat-number stat-number-pending" id="pendingCount">0</div>
        <div class="stat-label">Pending Review</div>
      </div>
      <div class="stat-card stat-card-approved">
        <div class="stat-number stat-number-approved" id="approvedCount">0</div>
        <div class="stat-label">Approved</div>
      </div>
      <div class="stat-card stat-card-denied ">
        <div class="stat-number stat-number-denied" id="deniedCount">0</div>
        <div class="stat-label">Denied</div>
      </div>
    </div>

    <div class="permits-list">
      <div class="list-header">
        <i class="fas fa-list"></i> Your Applications
        <button class="btn btn-sm btn-light float-end" onclick="loadUserApplications()">
          <i class="fas fa-sync"></i> Refresh
        </button>
      </div>
      <div id="permitsContainer" class="fade-container"></div>
      <div id="paginationControls" class="pagination-controls"></div>
    </div>

    <div class="text-center mt-4">
      <a href="/form-page" class="btn-new-application">
        <i class="fas fa-plus"></i> Submit New Application
      </a>
    </div>
  </div>
{% else %}
  <div class="container py-5 text-center">
    <div class="card mx-auto p-4" style="max-width: 400px;">
      <h2 class="mb-3"><i class="fas fa-lock text-warning"></i> Login Required</h2>
      <p class="mb-4">You must be signed in to view your permits.</p>
      <a href="/signin" class="btn btn-primary">Sign In</a>
    </div>
  </div>
{% endif %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', loadUserApplications);

  const pageSize = 5; // apps per page
  let applications = [];
  let currentPage = 1;
  let totalPages = 1;

  async function loadUserApplications() {
    const permitsContainer = document.getElementById('permitsContainer');
    const totalCount = document.getElementById('totalCount');
    const pendingCount = document.getElementById('pendingCount');
    const approvedCount = document.getElementById('approvedCount');
    const deniedCount = document.getElementById('deniedCount');

    // Skeleton loader
    permitsContainer.innerHTML = '<div class="skeleton-item"></div><div class="skeleton-item"></div><div class="skeleton-item"></div>';

    try {
      const currentUserEmail = document.getElementById('user-data').getAttribute("data-user");

      const response = await fetch(`/_api/cre6c_nrc_permits_tables?$select=cre6c_applicantname,createdon,cre6c_applicationstatus,cre6c_projectedstartdate,cre6c_projectedenddate,cre6c_nrc_permits_tableid&$filter=cre6c_submissionby eq '${currentUserEmail}'`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      const data = await response.json();
      applications = data.value;

      // Stats
      totalCount.textContent = applications.length;
      pendingCount.textContent = applications.filter(app => app.cre6c_applicationstatus === 564980000).length;
      approvedCount.textContent = applications.filter(app => app.cre6c_applicationstatus === 564980001).length;
      deniedCount.textContent = applications.filter(app => app.cre6c_applicationstatus === 564980002).length;

      totalPages = Math.ceil(applications.length / pageSize);
      renderPage(1); // reset to first page

    } catch (error) {
      console.error('Error loading applications:', error);
      permitsContainer.innerHTML = `
        <div class="empty-state text-center">
          <i class="fas fa-exclamation-triangle fa-2x mb-2 text-warning"></i>
          <h4>Error Loading Applications</h4>
          <p>There was an error loading your applications. Please try refreshing the page.</p>
          <button class="btn btn-primary mt-2" onclick="loadUserApplications()">Retry</button>
        </div>`;
    }
  }

  function renderPage(page) {
    const permitsContainer = document.getElementById('permitsContainer');
    const paginationControls = document.getElementById('paginationControls');

    currentPage = page;

    // Transition: fade out
    permitsContainer.classList.add("fade-out");

    setTimeout(() => {
      // Slice apps for current page
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const pageApps = applications.slice(start, end);

      if (!pageApps.length) {
        permitsContainer.innerHTML = `
          <div class="empty-state text-center">
            <i class="fas fa-inbox fa-2x mb-2"></i>
            <h4>No Applications Yet</h4>
            <p>You haven't submitted any Environmental Review Applications.</p>
            <a href="/environmental-application" class="btn-new-application mt-2">
              <i class="fas fa-plus"></i> Submit Your First Application
            </a>
          </div>`;
      } else {
        permitsContainer.innerHTML = pageApps.map(app => {
          const statusLabel = getStatusLabel(app.cre6c_applicationstatus);
          const statusClass = getStatusClass(app.cre6c_applicationstatus);
          const submissionDate = app.createdon ? new Date(app.createdon).toLocaleDateString() : 'N/A';
          const startDate = app.cre6c_projectedstartdate ? new Date(app.cre6c_projectedstartdate).toLocaleDateString() : 'Not specified';
          const endDate = app.cre6c_projectedenddate ? new Date(app.cre6c_projectedenddate).toLocaleDateString() : 'Not specified';

          return `
            <div class="permit-item" onclick="viewApplication('${app.cre6c_nrc_permits_tableid}')">
              <div class="permit-info">
                <h4>${app.cre6c_applicantname || 'Unnamed Application'}</h4>
                <p><strong>Project Duration:</strong> ${startDate} - ${endDate}</p>
              </div>
              <div class="permit-meta">
                <div class="permit-date">Submitted: ${submissionDate}</div>
                <span class="status-badge ${statusClass}">${statusLabel}</span>
              </div>
            </div>`;
        }).join('');
      }

      // Pagination buttons
      paginationControls.innerHTML = "";

      // Prev button
      const prevBtn = document.createElement("button");
      prevBtn.textContent = "Prev";
      prevBtn.disabled = (currentPage === 1);
      prevBtn.onclick = () => renderPage(currentPage - 1);
      paginationControls.appendChild(prevBtn);

      // Numbered buttons
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === page) btn.classList.add("active");
        btn.onclick = () => renderPage(i);
        paginationControls.appendChild(btn);
      }

      // Next button
      const nextBtn = document.createElement("button");
      nextBtn.textContent = "Next";
      nextBtn.disabled = (currentPage === totalPages);
      nextBtn.onclick = () => renderPage(currentPage + 1);
      paginationControls.appendChild(nextBtn);

      // Fade back in
      permitsContainer.classList.remove("fade-out");
    }, 300); // matches transition duration
  }

  function getStatusLabel(status) {
    switch (status) {
      case 564980000: return 'Pending';
      case 564980001: return 'Approved';
      case 564980002: return 'Denied';
      default: return 'Unknown';
    }
  }

  function getStatusClass(status) {
    switch (status) {
      case 564980000: return 'status-pending';
      case 564980001: return 'status-approved';
      case 564980002: return 'status-denied';
      default: return 'status-unknown';
    }
  }

  function viewApplication(id) {
    window.location.href = `/permit-details?id=${id}`;
  }
</script>