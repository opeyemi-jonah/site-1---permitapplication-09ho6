{% if user %}
{% include 'portalwebapihelper' %}
{% assign current_user = user.emailaddress1 %}
<!-- Get user email -->
<div id="user-data" data-user='{{ current_user | jsonify | escape }}'></div>

<div class="permits-container">
  <div class="permits-header">
    <h1 class="text-white"><i class="fas fa-file-contract text-white"></i> My Permits Dashboard</h1>
    <p class="text-white">Track your Environmental Review Applications and their approval status</p>
  </div>

  <div class="permits-stats">
    <div class="stat-card">
      <div class="stat-number" id="totalCount">0</div>
      <div class="stat-label">Total Applications</div>
    </div>
    <div class="stat-card stat-card-pending">
      <div class="stat-number stat-number-pending" id="pendingCount">0</div>
      <div class="stat-label">Pending Review</div>
    </div>
    <div class="stat-card stat-card-approved">
      <div class="stat-number stat-number-approved" id="approvedCount">0</div>
      <div class="stat-label">Approved</div>
    </div>
    <div class="stat-card stat-card-denied ">
      <div class="stat-number stat-number-denied" id="deniedCount">0</div>
      <div class="stat-label">Denied</div>
    </div>
  </div>

  <div class="permits-list">
    <div class="list-header">
      <i class="fas fa-list"></i> Your Applications
      <button class="btn btn-sm btn-light float-end" onclick="loadUserApplications()">
        <i class="fas fa-sync"></i> Refresh
      </button>
    </div>
    <div id="permitsContainer" class="fade-container"></div>
    <div id="paginationControls" class="pagination-controls"></div>
  </div>

  <div class="text-center mt-4">
    <a href="/form-page" class="btn-new-application">
      <i class="fas fa-plus"></i> Submit New Application
    </a>
  </div>
</div>
{% else %}
<div class="container py-5 text-center">
  <div class="card mx-auto p-4" style="max-width: 400px;">
    <h2 class="mb-3"><i class="fas fa-lock text-warning"></i> Login Required</h2>
    <p class="mb-4">You must be signed in to view your permits.</p>
    <a href="/signin" class="btn btn-primary">Sign In</a>
  </div>
</div>
{% endif %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', loadUserApplications);


  // Data dictionaries for display name lookup
  const application_status_options = {
    564980000: "Pending",
    564980001: "Approved",
    564980002: "Denied"
  };
  const plant_design_options = {
    564980000: "Light-Water Reactor (LWR)",
    564980001: "Pressurized Water Reactor (PWR)",
    564980002: "Boiling Water Reactor (BWR)"
  };
  const financial_assurance_options = {
    564980000: "Self-Assurance",
    564980001: "Third-Party Assurance"
  };

  const pageSize = 5; // apps per page
  let applications = [];
  let currentPage = 1;
  let totalPages = 1;

  async function loadUserApplications() {
    const permitsContainer = document.getElementById('permitsContainer');
    const totalCount = document.getElementById('totalCount');
    const pendingCount = document.getElementById('pendingCount');
    const approvedCount = document.getElementById('approvedCount');
    const deniedCount = document.getElementById('deniedCount');

    // Skeleton loader
    permitsContainer.innerHTML = '<div class="skeleton-item"></div><div class="skeleton-item"></div><div class="skeleton-item"></div>';

    try {
      const currentUserEmail = document.getElementById('user-data').getAttribute("data-user");

      const response = await fetch(`/_api/cre6c_nrc_permits_tables?$select=cre6c_applicantname,
      cre6c_applicantemail,
      cre6c_applicantphone,
      createdon,
      cre6c_applicationstatus,
      cre6c_projectedstartdate,
      cre6c_projectedenddate,
      cre6c_primarycontactname,
      cre6c_primarycontactphone,
      cre6c_primarycontactemail,
      cre6c_plantname,
      cre6c_plantdesign,
      cre6c_reactormodel,
      cre6c_longitude,
      cre6c_latitude,
      cre6c_financialassurance,
      cre6c_initials,
      cre6c_termsaccepted,
      cre6c_nrc_permits_tableid&$filter=cre6c_submissionby eq '${currentUserEmail}'`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      const data = await response.json();
      applications = data.value;

      // Stats
      totalCount.textContent = applications.length;
      pendingCount.textContent = applications.filter(app => app.cre6c_applicationstatus === 564980000).length;
      approvedCount.textContent = applications.filter(app => app.cre6c_applicationstatus === 564980001).length;
      deniedCount.textContent = applications.filter(app => app.cre6c_applicationstatus === 564980002).length;

      totalPages = Math.ceil(applications.length / pageSize);
      renderPage(1); // reset to first page

    } catch (error) {
      console.error('Error loading applications:', error);
      permitsContainer.innerHTML = `
        <div class="empty-state text-center">
          <i class="fas fa-exclamation-triangle fa-2x mb-2 text-warning"></i>
          <h4>Error Loading Applications</h4>
          <p>There was an error loading your applications. Please try refreshing the page.</p>
          <button class="btn btn-primary mt-2" onclick="loadUserApplications()">Retry</button>
        </div>`;
    }
  }

  function renderPage(page) {
    const permitsContainer = document.getElementById('permitsContainer');
    const paginationControls = document.getElementById('paginationControls');

    currentPage = page;
    permitsContainer.classList.add("fade-out");

    setTimeout(() => {
      permitsContainer.innerHTML = "";

      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const pageApps = applications.slice(start, end);

      if (!pageApps.length) {
        permitsContainer.innerHTML = `
        <div class="empty-state text-center">
          <i class="fas fa-inbox fa-2x mb-2"></i>
          <h4>No Applications Yet</h4>
          <p>You haven't submitted any Environmental Review Applications.</p>
          <a href="/form-page" class="btn-new-application mt-2">
            <i class="fas fa-plus"></i> Submit Your First Application
          </a>
        </div>`;
      } else {
        pageApps.forEach(app => {
          const statusLabel = application_status_options[app.cre6c_applicationstatus] || getStatusLabel(app.cre6c_applicationstatus);
          const statusClass = getStatusClass(app.cre6c_applicationstatus);
          const submissionDate = app.createdon ? new Date(app.createdon).toLocaleDateString() : 'N/A';
          const startDate = app.cre6c_projectedstartdate ? new Date(app.cre6c_projectedstartdate).toLocaleDateString() : 'Not specified';
          const endDate = app.cre6c_projectedenddate ? new Date(app.cre6c_projectedenddate).toLocaleDateString() : 'Not specified';

          const div = document.createElement('div');
          div.className = 'permit-item';
          div.innerHTML = `
            <div class="permit-info">
              <h4>${app.cre6c_applicantname || 'Unnamed Application'}</h4>
              <p><strong>Project Duration:</strong> ${startDate} - ${endDate}</p>
            </div>
            <div class="permit-meta">
              <div class="permit-date">Submitted: ${submissionDate}</div>
              <span class="status-badge ${statusClass}">${statusLabel}</span>
            </div>
          `;
          div.addEventListener('click', () => viewApplication(app));
          permitsContainer.appendChild(div);
        });
      }

      // Enhanced pagination with First/Last
      paginationControls.innerHTML = "";

      if (totalPages > 1) {
        const firstBtn = document.createElement("button");
        firstBtn.textContent = "First";
        firstBtn.disabled = currentPage === 1;
        firstBtn.onclick = () => renderPage(1);
        paginationControls.appendChild(firstBtn);

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Prev";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => renderPage(currentPage - 1);
        paginationControls.appendChild(prevBtn);

        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            const btn = document.createElement("button");
            btn.textContent = i;
            if (i === page) btn.classList.add("active");
            btn.onclick = () => renderPage(i);
            paginationControls.appendChild(btn);
          } else if (i === 2 && currentPage > 3) {
            const ellipsis = document.createElement("span");
            ellipsis.textContent = "...";
            ellipsis.style.padding = "0 5px";
            paginationControls.appendChild(ellipsis);
          } else if (i === totalPages - 1 && currentPage < totalPages - 2) {
            const ellipsis = document.createElement("span");
            ellipsis.textContent = "...";
            ellipsis.style.padding = "0 5px";
            paginationControls.appendChild(ellipsis);
          }
        }

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => renderPage(currentPage + 1);
        paginationControls.appendChild(nextBtn);

        const lastBtn = document.createElement("button");
        lastBtn.textContent = "Last";
        lastBtn.disabled = currentPage === totalPages;
        lastBtn.onclick = () => renderPage(totalPages);
        paginationControls.appendChild(lastBtn);
      }

      permitsContainer.classList.remove("fade-out");
    }, 300);
  }

  function ensureModalExists() {
    if (!document.getElementById('permitDetailsModal')) {
      const modalHtml = `
      <div class="modal fade" id="permitDetailsModal" tabindex="-1" aria-labelledby="permitDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="permitDetailsModalLabel">Permit Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="permitDetailsModalBody">
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <div>Loading details...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
  }

  function viewApplication(app) {
    ensureModalExists();
    const modal = new bootstrap.Modal(document.getElementById('permitDetailsModal'));
    const modalBody = document.getElementById('permitDetailsModalBody');


    const statusLabel = application_status_options[app.cre6c_applicationstatus] || getStatusLabel(app.cre6c_applicationstatus);
    const statusClass = getStatusClass(app.cre6c_applicationstatus);
    const submissionDate = app.createdon ? new Date(app.createdon).toLocaleDateString() : 'N/A';
    const startDate = app.cre6c_projectedstartdate ? new Date(app.cre6c_projectedstartdate).toLocaleDateString() : 'Not specified';
    const endDate = app.cre6c_projectedenddate ? new Date(app.cre6c_projectedenddate).toLocaleDateString() : 'Not specified';

    modalBody.innerHTML = `
      <!-- Status Card -->
      <div class="card mb-4">
        <div class="card-header primary-bg-color rounded-2 text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0 text-white"><i class="fas fa-info-circle text-white"></i> Application Status</h4>
          <span class="status-badge ${statusClass}">${statusLabel}</span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Application ID:</strong> ${app.cre6c_nrc_permits_tableid}</p>
              <p><strong>Submitted:</strong> ${submissionDate}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Plant Name:</strong> ${app.cre6c_plantname || "Not specified"}</p>
              <p><strong>Location:</strong> ${app.cre6c_location || "Not specified"}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Applicant Information -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h2 class="mb-0"><i class="fas fa-user"></i> Applicant Information</h2>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Name:</strong> ${app.cre6c_applicantname || "Not provided"}</p>
              <p><strong>Email:</strong> ${app.cre6c_applicantemail || "Not provided"}</p>
              <p><strong>Phone:</strong> ${app.cre6c_applicantphone || "Not provided"}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Primary Contact:</strong> ${app.cre6c_primarycontactname || "Not provided"}</p>
              <p><strong>Contact Email:</strong> ${app.cre6c_primarycontactemail || "Not provided"}</p>
              <p><strong>Contact Phone:</strong> ${app.cre6c_primarycontactphone || "Not provided"}</p>
            </div>
          </div>
          ${
            app.cre6c_organizationstructure
              ? `
            <div class="row mt-3">
              <div class="col-12">
                <p><strong>Organization Structure:</strong></p>
                <p class="bg-light p-3 rounded">${app.cre6c_organizationstructure}</p>
              </div>
            </div>`
              : ""
          }
        </div>
      </div>

      <!-- Project Details -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h2 class="mb-0"><i class="fas fa-industry"></i> Project Details</h2>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Plant Design:</strong> ${plant_design_options[app.cre6c_plantdesign] || "Not provided"}</p>
              <p><strong>Reactor Model:</strong> ${app.cre6c_reactormodel || "Not provided"}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Latitude:</strong> ${app.cre6c_latitude || "Not provided"}</p>
              <p><strong>Longitude:</strong> ${app.cre6c_longitude || "Not provided"}</p>
            </div>
          </div>
          ${
            app.cre6c_operatinghistory
              ? `
            <div class="row mt-3">
              <div class="col-12">
                <p><strong>Operating History:</strong></p>
                <p class="bg-light p-3 rounded">${app.cre6c_operatinghistory}</p>
              </div>
            </div>`
              : ""
          }
        </div>
      </div>

      <!-- Schedule & Scope -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h2 class="mb-0"><i class="fas fa-calendar-alt"></i> Schedule & Scope</h2>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Projected Start Date:</strong> ${startDate}</p>
              <p><strong>Projected End Date:</strong> ${endDate}</p>
            </div>
          </div>
          ${
            app.cre6c_modificationdescription
              ? `
            <div class="row mt-3">
              <div class="col-12">
                <p><strong>Modification Description:</strong></p>
                <p class="bg-light p-3 rounded">${app.cre6c_modificationdescription}</p>
              </div>
            </div>`
              : ""
          }
        </div>
      </div>

      <!-- Assurance & Qualifications -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h2 class="mb-0"><i class="fas fa-shield-alt"></i> Assurance & Qualifications</h2>
        </div>
        <div class="card-body">
          <p><strong>Financial Assurance:</strong> ${financial_assurance_options[app.cre6c_financialassurance] || "Not selected"}</p>
          ${
            app.cre6c_experiencequalifications
              ? `
            <div class="mt-3">
              <p><strong>Experience and Qualifications:</strong></p>
              <p class="bg-light p-3 rounded">${app.cre6c_experiencequalifications}</p>
            </div>`
              : ""
          }
        </div>
      </div>

      <!-- Acknowledgement -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h2 class="mb-0"><i class="fas fa-check-circle"></i> Acknowledgement</h2>
        </div>
        <div class="card-body">
          <p><strong>Initials:</strong> ${app.cre6c_initials || "Not provided"}</p>
          <p class="text-muted">Applicant certified agreement to terms and conditions</p>
        </div>
      </div>
  `;

    modal.show();
  }
  function getStatusLabel(status) {
    switch (status) {
      case 564980000: return 'Pending';
      case 564980001: return 'Approved';
      case 564980002: return 'Denied';
      default: return 'Unknown';
    }
  }

  function getStatusClass(status) {
    switch (status) {
      case 564980000: return 'status-pending';
      case 564980001: return 'status-approved';
      case 564980002: return 'status-denied';
      default: return 'status-unknown';
    }
  }

  // function viewApplication(id) {
  //   window.location.href = `/permit-details?id=${id}`;
  // }
</script>